<!DOCTYPE html>
<head>
<title>Game Off</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<style>
body{
	margin:0;
    padding:5px;
    border:0;
    font-family:georgia,verdana,sans-serif;
    font-size:14px;
    background-color:#CCCCCC;
}
#thecanvas{
     background-color:#ffffff;
}
.number{
    width:50px;
}
</style>
<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
<script type="text/javascript">

var Scroller = (function(){

    window.requestAnimFrame = (function(){
        return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function(callback) {
              window.setTimeout(callback, 1000 / 60);
            };
        }
    )();    
    
    var imagesLeft = 0;
    function loadImg(src){  
        imagesLeft++;
        var img = new Image();
        img.onload = function(){
            imagesLeft--;
        };
        img.src = src;
        return img;
    }
    
    var images = {
        sprite:loadImg('sprite.png'),
        ground:loadImg('ground.png')
    };
    
    var THRUST = 8;
    var TERMINAL_VELOCITY = -8;
    var GRAVITY = 1;

    var Model = function(){       
        this.x = 150;
        this.y = 350;
        this.width = 25;
        this.thrust = 0; 
        this.jumping = false;
        this.falling = false;
        this.jumpDuration = 0;             
    };

    Model.prototype = {
        tick:function(floor){
            this.y = this.y - this.thrust;
            this.falling = this.y + 25 < floor;
                
            if(this.y > floor){ 
                this.jumping = false;
                this.y = floor;
                this.thrust = 0;
            }
            if(this.jumpDuration > 0)
                this.jumpDuration--;
            else
                this.thrust = Math.max(this.thrust - GRAVITY, TERMINAL_VELOCITY);
        },
        draw:function(ctx){
            ctx.drawImage(images.sprite, this.x, this.y);           
        },
        jump:function(){
            if(!this.jumping && !this.falling){
                this.jumping = true;
                this.jumpDuration = 20;
                this.thrust = THRUST;                               
            }
        },
        stopJump:function(){
            this.jumpDuration = 0;
        }
    };

    var Ground = function(x,y,blocks){
        this.x = x;
        this.y = y;
        this.blocks = blocks;
        this.width = blocks * 25;
    };
    
    Ground.prototype = {
        tick:function(){
            this.x = this.x - 2;
            if(this.x + this.width < 0)
                this.x = 600;
        },
        draw:function(ctx){
            var offset = 0;
            var b = this.blocks;
            while(b > 0){
                ctx.drawImage(images.ground, this.x + offset, this.y);
                offset += 25;
                b--;
            }           
        }
    };

    var controller = function(canvas){
        this.canvas = canvas;       
        this.ctx = canvas.getContext('2d');      
        this.model = new Model();        
        this.frame = 0;
        this.running = false;
        this.ground = [
            new Ground(100,100,4),
            new Ground(200,200,4),
            new Ground(300,300,4),
            new Ground(400,200,4),
            new Ground(500,100,4),
            new Ground(600,200,4)
        ];
    };

    controller.prototype = {
        toggle: function(){
            if(this.running){
                this.running = false;
                $(this.canvas).off('mousedown mouseup');
            }
            else{               
                this.frame = 0;
                this.running = true;
                var self = this;
                requestAnimFrame(function(){ self.tick(); });
                $(this.canvas).on('mousedown', function(){
                    self.model.jump();
                });
                $(this.canvas).on('mouseup', function(){
                    self.model.stopJump();
                });
            }
        },
        tick: function(){
            var model = this.model;

            var self = this;
            if(this.running)
                requestAnimFrame(function(){ self.tick(); });
            
            var floor = 350;
            
            var length = this.ground.length;
            for(var i = 0; i < length; i++){
                var block = this.ground[i];
                block.tick();
                if(block.x < model.x + model.width 
                    && block.x + block.width > model.x
                    && block.y > model.y + 24){
                    floor = block.y - model.width;
                }
            }

            model.tick(floor);            

            this.draw();
            this.frame++;
        },
        draw:function(){
            var ctx = this.ctx;            
           
            ctx.clearRect(0,0,this.canvas.width,this.canvas.height);

            ctx.fillStyle = 'rgb(0,0,0)';
            ctx.strokeText('Frame: ' + this.frame, 5, 15);
            ctx.fillRect(0,375,this.canvas.width,25);

            this.model.draw(ctx);
            var length = this.ground.length;
            for(var i = 0; i < length; i++){
                this.ground[i].draw(ctx);               
            }            
        },        
        go:function(){
            if(imagesLeft == 0){
                this.draw();
            }
            else{
                var self = this;
                setTimeout(function(){self.go();}, 200);
            }
        }
    };

    return { Controller: controller };
})();

$(document).ready(function(){
    var controller = new Scroller.Controller(document.getElementById('thecanvas'));
    controller.go();
    $('#toggle').click(function(){
        if($(this).val() == 'Start')
            $(this).val('Stop');
        else
            $(this).val('Start');
        controller.toggle();
    });    
});
</script>
</head>
<body>
<canvas id="thecanvas" width="600" height="400">
Your browser does not support the canvas element. Sorry.
</canvas>
<div>
    <input type="button" id="toggle" value="Start" />
</div>
</body>